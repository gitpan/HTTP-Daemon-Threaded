<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>HTTP::Daemon::Threaded</title>
<link rel="stylesheet" type="text/css" href="../../podstyle.css" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>
<div class="box">
  <h1 class="t1">HTTP::Daemon::Threaded</h1>
  <table>
    <tr>
      <td class="label">Description</td>
      <td class="cell">Apartment threaded HTTP::Daemon</td>
    </tr>
  </table>
</div>
<div class="path">
  <a href="../../index.html">HTTP::Daemon::Threaded</a> &gt; Package Manuals &gt;
  HTTP-Daemon-Threaded
</div>
<div>
<a href="./Threaded.html">Classdocs</a>
</div>


<div class="pod">
<!-- INDEX START -->
<h3 id="TOP">Index</h3>
<ul>
	<li><a href="#NAME">NAME</a></li>
	<li><a href="#SYNOPSIS">SYNOPSIS</a></li>
	<li><a href="#DESCRIPTION">DESCRIPTION</a></li>
	<li><a href="#METHODS">METHODS</a></li>
	<li><a href="#THEORY_OF_OPERATION">THEORY OF OPERATION</a><br />
<ul>
<li>
<ul>
	<li><a href="#HTTP_Daemon_Threaded">HTTP::Daemon::Threaded</a></li>
	<li><a href="#HTTP_Daemon_Threaded_Listener">HTTP::Daemon::Threaded::Listener</a></li>
	<li><a href="#HTTP_Daemon_Threaded_Logger">HTTP::Daemon::Threaded::Logger</a></li>
	<li><a href="#HTTP_Daemon_Threaded_SessionCache">HTTP::Daemon::Threaded::SessionCache</a></li>
	<li><a href="#HTTP_Daemon_Threaded_Session">HTTP::Daemon::Threaded::Session</a></li>
	<li><a href="#HTTP_Daemon_Threaded_ContentParams">HTTP::Daemon::Threaded::ContentParams</a></li>
	<li><a href="#HTTP_Daemon_Threaded_Content">HTTP::Daemon::Threaded::Content</a></li>
	<li><a href="#HTTP_Daemon_Threaded_WebClient">HTTP::Daemon::Threaded::WebClient</a></li>
</ul>
</li>
</ul>
</li>
	<li><a href="#SEE_ALSO">SEE ALSO</a></li>
	<li><a href="#TO_DO">TO DO</a></li>
	<li><a href="#AUTHOR_COPYRIGHT_AND_LICENSE">AUTHOR, COPYRIGHT, AND LICENSE</a></li>
</ul>
<hr />
<!-- INDEX END -->

<h1 id="NAME">NAME <a href="#TOP" class="toplink"><img alt="^" src="../../up.gif" /></a></h1>

<p>HTTP::Daemon::Threaded - Apartment threaded HTTP::Daemon-based server</p>

<h1 id="SYNOPSIS">SYNOPSIS <a href="#TOP" class="toplink"><img alt="^" src="../../up.gif" /></a></h1>

<pre>	#
	# create content handler class
	#
	package TestCGI;

	use HTTP::Date qw(time2str);
	use HTTP::Response;
	use HTTP::Daemon::Threaded::Content;
	use base ('HTTP::Daemon::Threaded::Content');

	use strict;
	use warnings;

	sub new {
		my $class = shift;
		return $class-&gt;SUPER::new(@_);	# use default constructor
	}

	sub getContent {
		my ($self, $fd, $request, $uri, $params, $session) = @_;

		return $fd-&gt;send_error(404)
			unless (($uri eq 'posted') || ($uri eq 'postxml'));

		my $html = '&lt;html&gt;&lt;body&gt;';
		my $ct = 'text/html';
		if ($uri eq 'posted') {
			$html .= &quot;$_ is $$params{$_}&lt;br&gt;\n&quot;
				foreach (sort keys %$params);
			$html .= &quot;&lt;/body&gt;&lt;/html&gt;\n&quot;;
		}
		else {
			$ct = 'text/xml';
			$html = $params;	# reflect the content
		}
		my $res = HTTP::Response-&gt;new(200, 'OK',
			[ 'Content-Type' =&gt; $ct,
				'Content-Length' =&gt; length($html),
				'Last-Modified' =&gt; time2str(time())
			]);
		$res-&gt;request($req);
		$res-&gt;content($html);
		return $fd-&gt;send_response($res);
	}

	sub getHeader {
		my ($self, $fd, $request, $uri, $params, $session) = @_;

		return $fd-&gt;send_error(404)
			unless (($uri eq 'posted') || ($uri eq 'postxml'));

		my $html = '&lt;html&gt;&lt;body&gt;';
		my $ct = 'text/html';
		if ($uri eq 'posted') {
			$html .= &quot;$_ is $$params{$_}&lt;br&gt;\n&quot;
				foreach (sort keys %$params);
			$html .= &quot;&lt;/body&gt;&lt;/html&gt;\n&quot;;
		}
		else {
			$ct = 'text/xml';
			$html = $params;	# its the content
		}
		my $res = HTTP::Response-&gt;new(200, 'OK',
			[ 'Content-Type' =&gt; $ct,
				'Content-Length' =&gt; length($html),
				'Last-Modified' =&gt; $mtime
			]);
		$res-&gt;request($req);
		return $fd-&gt;send_response($res);
	}
	#
	#	a container for content-specific parameters
	#
	package MyContentParams;

	use HTTP::Daemon::Threaded::ContentParams;
	use base qw(HTTP::Daemon::Threaded::ContentParams);

	...implementation goes here...
	#
	#	an event logger
	#
	package MyEventLog;

	use HTTP::Daemon::Threaded::Logger;
	use base qw(HTTP::Daemon::Threaded::Logger);

	...implementation goes here...
	#
	#	a web request logger
	#
	package MyWebLog;

	use HTTP::Daemon::Threaded::Logger;
	use base qw(HTTP::Daemon::Threaded::Logger);

	...implementation goes here...
	#
	#	now fire up a server
	#
	package main;

	use HTTP::Daemon::Threaded;
	use HTTP::Daemon::Threaded::SessionCache;
	use MyContentParams;
	use MyEventLog;
	use MyWebLog;
	use TestCGI;

	use strict;
	use warnings;
	#
	# create a SessionCache object using default implementation
	#
	my $session = HTTP::Daemon::SessionCache-&gt;new();
	#
	# create a ContentParams container
	#
	my $contparams = MyContentParams-&gt;new( @someArgs );

	my $evtlog = MyEventLog-&gt;new();
	my $weblog = MyWebLog-&gt;new();

	my $httpd = HTTP::Daemon::Threaded-&gt;new(
		Port			=&gt; 8080,
		MaxClients		=&gt; 20,
		ContentParams	=&gt; $contparams,
		SessionCache	=&gt; $sessions,
		LogLevel		=&gt; 3,		# full info logging
		EventLogger		=&gt; $evtlog,
		WebLogger		=&gt; $weblog,
		DocRoot			=&gt; './',	# root directory for default file handler
		Handlers		=&gt; [
			'^\/posted$', 'TestCGI',
			'^\/postxml$', 'TestCGI',
			'^.*\/scripty\.js$', '*',	# default file handler
			'^.*\/\w+\.html$', '*',		# default file handler
		],
		MediaTypes		=&gt; {
			'text/xml'	=&gt; [ 'xml', 'dtd' ],
		}
	) || die &quot;Unable to create web server, exitting.&quot;;

	...do other stuff...
	#
	# all done, shutdown
	#
	$httpd-&gt;shutdown();

</pre><h1 id="DESCRIPTION">DESCRIPTION <a href="#TOP" class="toplink"><img alt="^" src="../../up.gif" /></a></h1>

<p>HTTP::Daemon::Threaded provides an apartment threaded version of HTTP::Daemon,
with some additional extensions to simplify the process of providing content
handlers, logging, and session management. A port monitor object ('Listener')
spawns on or more worker thread objects ('WebClient's). As the Listener accepts
connection requests they are passed to the next available WebClient, which
reads requests, provides session management as needed, and dispatches the
requests to application specific content handler objects, or serves
file-based content directly by default.</p>

<p>HTTP::Daemon::Threaded is not intended as a replacement for high-volume
web servers (e.g., Apache); rather, it provides a more robust alternative
to <a href="http://search.cpan.org/perldoc?HTTP%3A%3ADaemon">HTTP::Daemon</a> (or other such single threaded) web server
solutions for embedding in standalone applications. In addition,
HTTP::Daemon::Threaded provides a (hopefully)
easier to use/configure interface than fully configuring an Apache server
(or other external web server application), or coding to the bare-bones
interfaces provided by <a href="http://search.cpan.org/perldoc?HTTP%3A%3ADaemon">HTTP::Daemon</a>. Possible uses include (e.g.)
browser based GUI apps (e.g., <a href="http://search.cpan.org/perldoc?Devel%3A%3APsichedb">Devel::Psichedb</a>), web-based application management
for non-web-server applications, etc.</p>

<h1 id="METHODS">METHODS <a href="#TOP" class="toplink"><img alt="^" src="../../up.gif" /></a></h1>

<p>Refer to the included classdocs for detailed method descriptions for all classes.</p>

<h1 id="THEORY_OF_OPERATION">THEORY OF OPERATION <a href="#TOP" class="toplink"><img alt="^" src="../../up.gif" /></a></h1>

<p>HTTP::Daemon::Threaded implements a multithreaded web server using apartment threading.
<i>Refer to</i> <a href="http://search.cpan.org/perldoc?Thread%3A%3AApartment">Thread::Apartment</a> <i>for the basic concepts of apartment threading.</i></p>

<p>The following classes are defined within the package:</p>

<h3 id="HTTP_Daemon_Threaded">HTTP::Daemon::Threaded</h3>

<p>A simple facade class to wrap the <a href="http://search.cpan.org/perldoc?Thread%3A%3AApartment">Thread::Apartment</a> constructor for the
HTTP::Daemon::Threaded::Listener class</p>

<h3 id="HTTP_Daemon_Threaded_Listener">HTTP::Daemon::Threaded::Listener</h3>

<p>A port monitor that creates a pool of HTTP::Daemon::Threaded::WebClient
objects to handle client HTTP requests, then listens on a defined port,
accepts the connection, allocates any free WebClient object, and installs
the connection in it. If no WebClients are available, the connection is closed.</p>

<h3 id="HTTP_Daemon_Threaded_Logger">HTTP::Daemon::Threaded::Logger</h3>

<p>Base class defining the interfaces for logging. HTTP::Daemon::Threaded defines
2 types of loggers: event loggers, which record general event information,
including errors, warnings, and diagnostic messages, and web loggers, which are
used solely to record client web requests.</p>

<h3 id="HTTP_Daemon_Threaded_SessionCache">HTTP::Daemon::Threaded::SessionCache</h3>

<p>Base class for managing session context; acts as a factory and container class for
HTTP::Daemon::Threaded::Session objects. Should be a threads::shared object which
can be shared between all the apartment threads. While a minimal cookie-based
implementation is provided, applications requiring session management capability
are expected to implement an appropriate subclass.</p>

<h3 id="HTTP_Daemon_Threaded_Session">HTTP::Daemon::Threaded::Session</h3>

<p>Base class for managing and maintaining any state needed for a single session.
Should be a threads::shared object which can be shared between all apartment threads.
Applications requiring session management capability
are expected to implement an appropriate subclass.</p>

<h3 id="HTTP_Daemon_Threaded_ContentParams">HTTP::Daemon::Threaded::ContentParams</h3>

<p>Base container class for any persistent information required for content handlers.
May be threads::shared if shared context is needed.</p>

<h3 id="HTTP_Daemon_Threaded_Content">HTTP::Daemon::Threaded::Content</h3>

<p>Base class for content handlers. When a URI matches a corresponding regular expression,
the request is forwarded to an instance of this class to generate either the
content or header, or to save content for PUT requests. Each WebClient will create
its own private instance of each defined content handler class. SessionCache,
ContentParams, EventLogger, and WebLogger instances are installed in content handler
classes, and thus Content objects should not retain any persistent state of their own.</p>

<h3 id="HTTP_Daemon_Threaded_WebClient">HTTP::Daemon::Threaded::WebClient</h3>

<p>Manages a single client connnection. During construction, it accepts
a content handler map, HTTP::Daemon::Threaded::ContentParams instance,
and a HTTP::Daemon::Threaded::SessionCache instance.</p>

<p>The content handler map is an array of pairs of regular expression strings
and HTTP::Daemon::Threaded::Content classes that are used to select a
content handler object for a given client request URI. The regular expressions
are evaluated against the URI in sequential order, and, if a match occurs,
one of the content handler's <code>getContent(), getHeader(), or putContent()</code> methods
is called to process the request. <i>Note</i> that the regular expressions strings
must be provided as true string literals, <strong>not</strong> as &quot;qr//&quot; compiled expressions,
as the <a href="http://search.cpan.org/perldoc?Thread%3A%3AApartment">Thread::Apartment</a> method of marshalling the handler map to WebClient
constructors causes them to be &quot;frozen&quot; and &quot;thawed&quot; via <a href="http://search.cpan.org/perldoc?Storable">Storable</a>, which does
not yet properly handle thawing regular expression values (except by using the
<a href="http://search.cpan.org/perldoc?Regexp%3A%3AStorable">Regexp::Storable</a> package, which Thread::Apartment's default marshalling does
not yet support).</p>

<p>HTTP::Daemon::Threaded::Content is a simple abstract class with a default
implementation that returns a 404 HTTP status for any request.
Applications are expected to implement subclasses of the Content class for the
various URIs. One exception is the special classname <strong>'*'</strong>, which indicates
the request should be handled by WebClient's default content handler, which
uses the configured DocRoot property to locate the URI as a file and return it.</p>

<p>Content handler classes should avoid maintaining state; any content-related
state should be managed with the installed ContentParams object, and any session related
state should be managed with any provided Session object.</p>

<p>Client connection requests are received as <a href="http://search.cpan.org/perldoc?HTTP%3A%3ARequest">HTTP::Request</a> objects, and
processed as follows:</p>

<ul>
	<li>If a SessionCache was provided, the client is checked for a cookie; if one exists,
WebClient invokes the SessionCache to retrieve or create a Session object for the client.</li>
	<li>The URI and method headers are retrieved and validated. If url-form-encoded
parameters are provided, they are extracted; if the request is a multipart POST
request, the parts are collected. If the request is a PUT, the decoded request
content is collected.</li>
	<li>The URI is successively applied to the content handler map regular expressions until
a match is found. If no match is found, a 404 HTTP status is returned to the client.
Otherwise, the client connection object, URI, request object, URI parameters,
and the session object (if any) are passed to the content handler,
which is responsible for producing the content into an HTTP::Response object
and sending it back to the client.</li>
</ul>

<p>WebClient objects will hold onto a client connection (in conformance with
HTTP 1.1 connection persistance) until either the client explicitly disconnects,
or any configured inactivity timer expires, at which point any session for
the connection is closed, the connection is closed, and the WebClient returns
itself to the free pool.</p>

<h1 id="SEE_ALSO">SEE ALSO <a href="#TOP" class="toplink"><img alt="^" src="../../up.gif" /></a></h1>

<p><a href="http://search.cpan.org/perldoc?Thread%3A%3AApartment">Thread::Apartment</a></p>

<p><a href="http://search.cpan.org/perldoc?HTTP%3A%3ADaemon">HTTP::Daemon</a></p>

<h1 id="TO_DO">TO DO <a href="#TOP" class="toplink"><img alt="^" src="../../up.gif" /></a></h1>

<dl>
	<dt>SSL Support</dt>
		<dd><p>Via Crypt::SSLeay(or IO::Socket::SSL) + OpenSSL</p></dd>
	<dt>Default User Auth support</dt>
		<dd><p>Currently no user authorization/authentication classes are defined;
some abstract class is needed to encapsulate such functionality.</p></dd>
	<dt>More/Better Session/SessionCache subclasses</dt>
		<dd><p>The current session management implementation is non-persistent,
and cookie based. Persistent, URI-rewrite or other mechanisms
are desirable.</p></dd>
	<dt>Multiplex WebClient</dt>
		<dd><p>Permit a WebClient to handle multiple open sockets.</p></dd>
	<dt>DBI Connection/Statement ppols</dt>
		<dd><p>Add DBIPool object to contain both DBI (rather, DBIx::Threaded)
connection and statement pools</p></dd>
</dl>
<h1 id="AUTHOR_COPYRIGHT_AND_LICENSE">AUTHOR, COPYRIGHT, AND LICENSE <a href="#TOP" class="toplink"><img alt="^" src="../../up.gif" /></a></h1>

<p>Copyright(C) 2006, Dean Arnold, Presicient Corp., USA. All rights reserved.</p>

<p>Licensed under the Academic Free License version 2.1, as specified in the
License.txt file included in this software package, or at OpenSource.org
<a href="http://www.opensource.org/licenses/afl-2.1.php">http://www.opensource.org/licenses/afl-2.1.php</a>.
</p>


</div><div class="footer">generated by <a href="http://search.cpan.org/perldoc?Pod%3A%3AProjectDocs">Pod::ProjectDocs</a></div></body>
</html>
